<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chats</title>
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div id="container">
      <div id="chats">
        <div id="chats-header">Heyo Chat</div>
        <input
          type="email"
          id="email-input"
          name="email"
          placeholder="enter email"
        />
        <button id="search-btn" onclick="search(event)">Search</button>
      </div>
      <div id="messages">
        <div id="messages-header">
          <p>message header</p>
        </div>
        <div id="chat-messages"></div>
        <div id="message-box-container">
          <form id="message-form" onsubmit="sendMessage(event)">
            <input
              type="text"
              id="message-box"
              name="message_box"
              placeholder="hi there ðŸ‘‹"
            />
          </form>
          <div id="send-btn">
            <!-- <img
              width="35"
              height="35"
              src="assets/images/send-svgrepo-com.svg"
              alt="send btn"
            /> -->
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js"
      integrity="sha512-h9644v03pHqrIHThkvXhB2PJ8zf5E9IyVnrSfZg8Yj8k4RsO4zldcQc4Bi9iVLUCCsqNY0b4WXVV4UB+wbWENA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script src="../js/verifyToken.js"></script>

    <!-- <script>
      document.addEventListener("DOMContentLoaded", async () => {
         await loadAllMessages();
      });
    </script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const token = localStorage.getItem("token");

      // connecting with socket.io backend
      const socket = io("ws://localhost:3000", {
        auth: {
          token,
        },
      });

      // listening for incoming message in room event
      socket.on("recieve-new-message-in-room", (data) => {
        showMessage(data);
      });

      socket.on("recieve-new-message-in-group", (data) => {
        showMessage(data);
      });

      // sends the message to socket.io server
      const sendMessage = (event) => {
        event.preventDefault();

        const message = event.target.message_box.value;

        // socket.emit("send-new-message-in-room", {
        //   message,
        //   roomName: window.roomName,
        // });

        socket.emit("send-message-in-group", {
          message,
          groupName: window.groupName,
        });
      };

      // shows the message on DOM
      const showMessage = (data) => {
        const messagesContainer = document.getElementById("chat-messages");
        const messageElem = document.createElement("span");
        messageElem.classList = "message";

        messageElem.innerHTML = `
        User Name:
       ${data.name}
        Message:
        ${data.message}`;

        messagesContainer.appendChild(messageElem);
      };

      // joining a group using email
      const search = async (event) => {
        const myEmail = localStorage.getItem("myEmail");
        const emailInput = document.getElementById("email-input");
        const email = emailInput.value;

        try {
          const res = await axios.post(
            "http://localhost:3000/api/verify-email",
            {
              email,
            },
          );

          const roomName = [myEmail, email].sort().join("-");
          console.log(roomName);
          window.roomName = roomName;

          window.groupName = roomName;

          // emitting the join room event
          // socket.emit("join-room", roomName);
          socket.emit("join-group", window.groupName);
          emailInput.value = "";
        } catch (error) {
          if (error.status === 404) {
            console.error(`user with email ${email} not found`);
          }
          // console.log(error);
        }
      };
    </script>

    <script src="../js/script.js"></script>
  </body>
</html>
